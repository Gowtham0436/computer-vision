{% extends "base.html" %}
{% block title %}Module 3 - Problem 2{% endblock %}
{% block header %}Module 3 - Problem 2{% endblock %}
{% block subheader %}Edge and Corner Detection{% endblock %}

{% block styles %}
<style>
  .main-container { max-width: 1200px; margin: 0 auto; }
  .upload-section { text-align: center; margin-bottom: 30px; }
  .upload-box { border: 3px dashed #667eea; border-radius: 10px; padding: 40px; cursor: pointer; transition: background 0.3s; display: inline-block; }
  .upload-box:hover { background: #f8f9fa; }
  .image-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0; }
  .image-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
  .image-card h4 { margin: 0 0 10px 0; color: #667eea; }
  img { 
    max-width: 100%; 
    max-height: 400px; 
    width: auto; 
    height: auto; 
    border-radius: 8px; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
    display: block; 
    margin: 0 auto; 
  }
  .params-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
  .param-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
  .param-item label { display: block; margin-bottom: 5px; font-weight: 500; }
  .param-item input { width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px; }
  .results-section { background: #e8f5e9; padding: 20px; border-radius: 10px; margin-top: 20px; }
  .loading { text-align: center; padding: 20px; color: #667eea; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
  <div style="margin-bottom: 20px;">
    <a href="/module3" class="btn">‚Üê Back to Module 3</a>
    <a href="/modules" class="btn">All Modules</a>
  </div>

  <h2>Problem 2: Edge and Corner Detection</h2>
  <ol style="line-height: 1.8; margin-bottom: 20px;">
    <li>Upload an image from your dataset</li>
    <li>Adjust parameters (optional) for edge and corner detection</li>
    <li>Click <strong>Detect Edges</strong> or <strong>Detect Corners</strong> to see results</li>
    <li>Compare original with detected features</li>
  </ol>

  <div class="upload-section">
    <div class="upload-box" onclick="document.getElementById('imageInput').click()">
      <h3>üì§ Upload Image</h3>
      <p>JPG / PNG / JPEG</p>
      <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleFileUpload(event)">
    </div>
    <p id="fileName2" style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em; display: none;"></p>
  </div>

  <div class="params-section">
    <h3>Detection Parameters</h3>
    <div class="param-group">
      <div class="param-item">
        <label>Edge Threshold 1 (Canny)</label>
        <input type="number" id="threshold1" value="50" min="0" max="255">
      </div>
      <div class="param-item">
        <label>Edge Threshold 2 (Canny)</label>
        <input type="number" id="threshold2" value="150" min="0" max="255">
      </div>
      <div class="param-item">
        <label>Max Corners</label>
        <input type="number" id="maxCorners" value="100" min="1" max="500">
      </div>
      <div class="param-item">
        <label>Corner Quality</label>
        <input type="number" id="quality" value="0.01" min="0.001" max="0.1" step="0.001">
      </div>
    </div>
  </div>

  <div style="text-align:center; margin: 20px 0;">
    <button id="edgeBtn" class="btn btn-success" onclick="detectEdges()" disabled>Detect Edges</button>
    <button id="cornerBtn" class="btn btn-success" onclick="detectCorners()" disabled>Detect Corners</button>
    <button class="btn btn-secondary" onclick="resetAll()">Reset All</button>
  </div>

  <div id="loadingSection" style="display:none;" class="loading">
    <p>Processing image... Please wait.</p>
  </div>

  <div id="errorSection" style="display:none;" class="alert alert-error">
    <p id="errorMessage"></p>
  </div>

  <div id="edgeResults" style="display:none;">
    <h3>Edge Detection Results</h3>
    <div class="image-grid">
      <div class="image-card">
        <h4>Original Image</h4>
        <img id="edgeOriginalImg" alt="Original">
      </div>
      <div class="image-card">
        <h4>Detected Edges</h4>
        <img id="edgesImg" alt="Edges">
      </div>
      <div class="image-card">
        <h4>Edges Overlay</h4>
        <img id="edgesOverlayImg" alt="Edges Overlay">
      </div>
    </div>
    <div class="results-section">
      <div><strong>Edge Pixels Detected:</strong> <span id="edgeCount">0</span></div>
    </div>
  </div>

  <div id="cornerResults" style="display:none;">
    <h3>Corner Detection Results</h3>
    <div class="image-grid">
      <div class="image-card">
        <h4>Original Image</h4>
        <img id="cornerOriginalImg" alt="Original">
      </div>
      <div class="image-card">
        <h4>Detected Corners</h4>
        <img id="cornersImg" alt="Corners">
      </div>
    </div>
    <div class="results-section">
      <div><strong>Corners Detected:</strong> <span id="cornerCount">0</span></div>
      <div><strong>Harris Corners:</strong> <span id="harrisCount">0</span></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let imageBase64 = null;

function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    const dataUrl = ev.target.result;
    imageBase64 = dataUrl.split(',')[1];
    document.getElementById('edgeBtn').disabled = false;
    document.getElementById('cornerBtn').disabled = false;
    document.getElementById('edgeResults').style.display = 'none';
    document.getElementById('cornerResults').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';
    // Show filename
    document.getElementById('fileName2').textContent = `Uploaded: ${file.name}`;
    document.getElementById('fileName2').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function detectEdges() {
  if (!imageBase64) {
    alert('Please upload an image first');
    return;
  }
  
  document.getElementById('loadingSection').style.display = 'block';
  document.getElementById('edgeResults').style.display = 'none';
  document.getElementById('errorSection').style.display = 'none';
  document.getElementById('edgeBtn').disabled = true;
  
  try {
    const threshold1 = parseInt(document.getElementById('threshold1').value) || 50;
    const threshold2 = parseInt(document.getElementById('threshold2').value) || 150;
    
    const response = await fetch('/module3/api/detect_edges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        image: imageBase64,
        threshold1: threshold1,
        threshold2: threshold2
      })
    });
    
    const result = await response.json();
    document.getElementById('loadingSection').style.display = 'none';
    
    if (result.success) {
      document.getElementById('edgeOriginalImg').src = 'data:image/png;base64,' + result.original_image;
      document.getElementById('edgesImg').src = 'data:image/png;base64,' + result.edges;
      document.getElementById('edgesOverlayImg').src = 'data:image/png;base64,' + result.edges_overlay;
      document.getElementById('edgeCount').textContent = result.edge_count.toLocaleString();
      document.getElementById('edgeResults').style.display = 'block';
    } else {
      document.getElementById('errorMessage').textContent = result.error || 'An error occurred';
      document.getElementById('errorSection').style.display = 'block';
    }
  } catch (err) {
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('errorMessage').textContent = 'Error: ' + err.message;
    document.getElementById('errorSection').style.display = 'block';
    console.error(err);
  } finally {
    document.getElementById('edgeBtn').disabled = false;
  }
}

async function detectCorners() {
  if (!imageBase64) {
    alert('Please upload an image first');
    return;
  }
  
  document.getElementById('loadingSection').style.display = 'block';
  document.getElementById('cornerResults').style.display = 'none';
  document.getElementById('errorSection').style.display = 'none';
  document.getElementById('cornerBtn').disabled = true;
  
  try {
    const maxCorners = parseInt(document.getElementById('maxCorners').value) || 100;
    const quality = parseFloat(document.getElementById('quality').value) || 0.01;
    const minDistance = 10;
    
    const response = await fetch('/module3/api/detect_corners', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        image: imageBase64,
        max_corners: maxCorners,
        quality: quality,
        min_distance: minDistance
      })
    });
    
    const result = await response.json();
    document.getElementById('loadingSection').style.display = 'none';
    
    if (result.success) {
      document.getElementById('cornerOriginalImg').src = 'data:image/png;base64,' + result.original_image;
      document.getElementById('cornersImg').src = 'data:image/png;base64,' + result.corners_visualization;
      document.getElementById('cornerCount').textContent = result.corner_count;
      document.getElementById('harrisCount').textContent = result.harris_corners;
      document.getElementById('cornerResults').style.display = 'block';
    } else {
      document.getElementById('errorMessage').textContent = result.error || 'An error occurred';
      document.getElementById('errorSection').style.display = 'block';
    }
  } catch (err) {
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('errorMessage').textContent = 'Error: ' + err.message;
    document.getElementById('errorSection').style.display = 'block';
    console.error(err);
  } finally {
    document.getElementById('cornerBtn').disabled = false;
  }
}

function resetAll() {
  if (confirm('Reset everything and start over?')) {
    imageBase64 = null;
    document.getElementById('imageInput').value = '';
    document.getElementById('edgeResults').style.display = 'none';
    document.getElementById('cornerResults').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';
    document.getElementById('edgeBtn').disabled = true;
    document.getElementById('cornerBtn').disabled = true;
    document.getElementById('fileName2').style.display = 'none';
  }
}
</script>
{% endblock %}
