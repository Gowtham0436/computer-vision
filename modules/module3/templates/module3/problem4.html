{% extends "base.html" %}
{% block title %}Module 3 - Problem 4{% endblock %}
{% block header %}Module 3 - Problem 4{% endblock %}
{% block subheader %}ArUco Marker Segmentation{% endblock %}

{% block styles %}
<style>
  .main-container { max-width: 1200px; margin: 0 auto; }
  .upload-section { text-align: center; margin-bottom: 30px; }
  .upload-box { border: 3px dashed #667eea; border-radius: 10px; padding: 40px; cursor: pointer; transition: background 0.3s; display: inline-block; }
  .upload-box:hover { background: #f8f9fa; }
  .image-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0; }
  .image-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
  .image-card h4 { margin: 0 0 10px 0; color: #667eea; }
  canvas, img { 
    max-width: 100%; 
    max-height: 400px; 
    width: auto; 
    height: auto; 
    border-radius: 8px; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
    display: block; 
    margin: 0 auto; 
    image-rendering: -webkit-optimize-contrast;
    image-rendering: auto;
  }
  .info-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #2196F3; }
  .results-section { background: #e8f5e9; padding: 20px; border-radius: 10px; margin-top: 20px; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
  <div style="margin-bottom: 20px;">
    <a href="/module3" class="btn">‚Üê Back to Module 3</a>
    <a href="/modules" class="btn">All Modules</a>
  </div>

  <h2>Problem 4: ArUco Marker Segmentation</h2>
  <ol style="line-height: 1.8; margin-bottom: 20px;">
    <li>Place ArUco markers on the boundary of a non-rectangular object</li>
    <li>Capture image from various distances and angles (use at least 10 images)</li>
    <li>Upload image with visible ArUco markers</li>
    <li>Click <strong>Segment Object</strong> to detect markers and segment the object</li>
  </ol>

  <div class="info-box">
    <h3 style="margin-top: 0; color: #1976D2;">üìã ArUco Marker Guidelines</h3>
    <ul style="text-align: left; line-height: 1.8;">
      <li>Use <strong>6x6 ArUco markers</strong> (DICT_6X6_250)</li>
      <li>Place markers on the <strong>boundary/edges</strong> of the object</li>
      <li>Ensure markers are <strong>clearly visible</strong> and not occluded</li>
      <li>Use at least <strong>3-4 markers</strong> for good boundary detection</li>
      <li>Test with images from <strong>different angles and distances</strong></li>
      <li>Markers should be <strong>well-lit</strong> and in focus</li>
    </ul>
  </div>

  <div class="upload-section">
    <div class="upload-box" onclick="document.getElementById('imageInput').click()">
      <h3>üì§ Upload Image with ArUco Markers</h3>
      <p>JPG / PNG / JPEG</p>
      <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleFileUpload(event)">
    </div>
  </div>

  <div style="text-align:center; margin: 20px 0;">
    <button id="segmentBtn" class="btn btn-success" onclick="segmentObject()" disabled>Segment Object</button>
    <button class="btn btn-secondary" onclick="resetAll()">Reset All</button>
  </div>

  <div id="resultsSection" style="display:none;">
    <h3>Segmentation Results</h3>
    <div class="image-grid">
      <div class="image-card">
        <h4>Original Image</h4>
        <img id="originalImg" alt="Original">
      </div>
      <div class="image-card">
        <h4>Markers Detected</h4>
        <img id="markersImg" alt="Markers">
      </div>
      <div class="image-card">
        <h4>Segmented Object</h4>
        <img id="segmentedImg" alt="Segmented">
      </div>
      <div class="image-card">
        <h4>Segmentation Overlay</h4>
        <img id="overlayImg" alt="Overlay">
      </div>
    </div>
    <div class="results-section">
      <div><strong>ArUco Markers Detected:</strong> <span id="markerCount">0</span></div>
      <div><strong>Segmented Area:</strong> <span id="area">0</span> pixels¬≤</div>
      <div><strong>Boundary Perimeter:</strong> <span id="perimeter">0</span> pixels</div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- OpenCV.js -->
<script src="https://docs.opencv.org/4.x/opencv.js" 
  onload="if(window.initModule3Problem4) initModule3Problem4();"
  onerror="console.error('Failed to load OpenCV.js')"></script>

<!-- Assignment 3 Core Logic -->
<script src="{{ url_for('static', filename='js/module3/assignment3_core.js') }}"></script>

<script>
let cvReady = false;
let srcMat = null;
let uploadedImage = null;
let arucoAPI = null;

// Wait for OpenCV to load
function waitForCV() {
  return new Promise((resolve) => {
    if (window.cv && typeof window.cv.Mat === 'function') {
      cvReady = true;
      // Initialize ArUco API
      arucoAPI = getArucoAPI(window.cv);
      if (arucoAPI) {
        console.log('‚úÖ ArUco API initialized:', arucoAPI.mode);
      } else {
        console.warn('‚ö†Ô∏è ArUco API not available');
      }
      resolve();
      return;
    }
    window.cv = window.cv || {};
    window.cv.onRuntimeInitialized = () => {
      cvReady = true;
      // Initialize ArUco API
      arucoAPI = getArucoAPI(window.cv);
      if (arucoAPI) {
        console.log('‚úÖ ArUco API initialized:', arucoAPI.mode);
      } else {
        console.warn('‚ö†Ô∏è ArUco API not available');
      }
      resolve();
    };
    const intv = setInterval(() => {
      if (window.cv && typeof window.cv.Mat === 'function') {
        clearInterval(intv);
        cvReady = true;
        // Initialize ArUco API
        arucoAPI = getArucoAPI(window.cv);
        if (arucoAPI) {
          console.log('‚úÖ ArUco API initialized:', arucoAPI.mode);
        } else {
          console.warn('‚ö†Ô∏è ArUco API not available');
        }
        resolve();
      }
    }, 50);
  });
}

function matToDataURL(mat) {
  const canvas = document.createElement('canvas');
  canvas.width = mat.cols;
  canvas.height = mat.rows;
  cv.imshow(canvas, mat);
  return canvas.toDataURL('image/png');
}

function handleFileUpload(e) {
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = async (ev) => {
    uploadedImage = ev.target.result;
    await waitForCV();
    document.getElementById('segmentBtn').disabled = false;
    document.getElementById('resultsSection').style.display = 'none';
  };
  r.readAsDataURL(f);
}

async function segmentObject() {
  if (!cvReady) {
    await waitForCV();
  }
  
  if (!uploadedImage) {
    alert('Please upload an image first');
    return;
  }
  
  if (!arucoAPI) {
    alert('ArUco API not available. Please ensure OpenCV.js includes ArUco module.');
    return;
  }
  
  try {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      
      if (srcMat) srcMat.delete();
      srcMat = cv.imread(canvas);
      
      // Use Assignment 3 ArUco segmentation
      const dictName = 'DICT_6X6_250';
      const useCorners = true;
      const showIds = true;
      const dilate = 2;
      
      const { out: segmented, info, markerCount, area, perimeter, points } = segAruco(
        srcMat, arucoAPI, dictName, useCorners, showIds, dilate
      );
      
      // Create markers-only visualization
      const markersOnly = new cv.Mat();
      cv.cvtColor(srcMat, markersOnly, cv.COLOR_RGBA2RGB);
      
      // Draw markers
      const gray = new cv.Mat();
      cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);
      const corners = new cv.MatVector();
      const ids = new cv.Mat();
      try {
        arucoAPI.detect(gray, arucoAPI.dictionary, corners, ids, arucoAPI.params);
        if (ids.rows > 0 && arucoAPI.draw) {
          arucoAPI.draw(markersOnly, corners, ids);
        }
      } catch (e) {
        console.warn('Marker drawing failed:', e);
      }
      gray.delete();
      corners.delete();
      ids.delete();
      
      // Create segmented-only visualization (mask)
      const segmentedOnly = new cv.Mat();
      cv.cvtColor(srcMat, segmentedOnly, cv.COLOR_RGBA2RGB);
      if (points.length >= 3) {
        const contour = new cv.Mat(points.length, 1, cv.CV_32SC2);
        for (let i = 0; i < points.length; i++) {
          const ptr = contour.intPtr(i, 0);
          ptr[0] = points[i].x;
          ptr[1] = points[i].y;
        }
        const mask = cv.Mat.zeros(srcMat.rows, srcMat.cols, cv.CV_8U);
        const mv = new cv.MatVector();
        mv.push_back(contour);
        cv.fillPoly(mask, mv, new cv.Scalar(255));
        mv.delete();
        contour.delete();
        
        // Apply mask
        segmentedOnly.setTo(new cv.Scalar(0, 0, 0), new cv.Mat(segmentedOnly.rows, segmentedOnly.cols, cv.CV_8U, new cv.Scalar(255)).subtract(mask));
        const fillRGB = new cv.Mat(srcMat.rows, srcMat.cols, cv.CV_8UC3, new cv.Scalar(0, 255, 0, 0));
        fillRGB.copyTo(segmentedOnly, mask);
        fillRGB.delete();
        mask.delete();
      }
      
      document.getElementById('originalImg').src = uploadedImage;
      document.getElementById('markersImg').src = matToDataURL(markersOnly);
      document.getElementById('segmentedImg').src = matToDataURL(segmentedOnly);
      document.getElementById('overlayImg').src = matToDataURL(segmented);
      document.getElementById('markerCount').innerText = markerCount || 0;
      document.getElementById('area').innerText = area ? area.toFixed(2) : 'N/A';
      document.getElementById('perimeter').innerText = perimeter ? perimeter.toFixed(2) : 'N/A';
      document.getElementById('resultsSection').style.display = 'block';
      
      segmented.delete();
      markersOnly.delete();
      segmentedOnly.delete();
    };
    img.src = uploadedImage;
  } catch(err) {
    alert('Error: ' + err.message);
    console.error(err);
  }
}

function resetAll() {
  if(confirm('Reset everything and start over?')) {
    uploadedImage = null;
    if (srcMat) {
      srcMat.delete();
      srcMat = null;
    }
    document.getElementById('imageInput').value = '';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('segmentBtn').disabled = true;
  }
}

function initModule3Problem4() {
  waitForCV().then(() => {
    console.log('OpenCV.js ready for Problem 4');
  });
}

// Initialize if OpenCV already loaded
if (window.cv && typeof window.cv.Mat === 'function') {
  initModule3Problem4();
}
</script>
{% endblock %}

