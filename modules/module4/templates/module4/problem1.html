{% extends "base.html" %}
{% block title %}Module 4 - Problem 1{% endblock %}
{% block header %}Module 4 - Problem 1{% endblock %}
{% block subheader %}Image Stitching{% endblock %}

{% block styles %}
<style>
  .main-container { max-width: 1400px; margin: 0 auto; }
  .upload-section { text-align: center; margin-bottom: 30px; }
  .upload-box { border: 3px dashed #667eea; border-radius: 10px; padding: 30px; cursor: pointer; transition: background 0.3s; display: inline-block; margin: 10px; min-width: 200px; }
  .upload-box:hover { background: #f8f9fa; }
  .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
  .preview-item { position: relative; }
  .preview-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; }
  .preview-item .remove-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold; }
  canvas, img { 
    max-width: 100%; 
    max-height: 600px; 
    width: auto; 
    height: auto; 
    border-radius: 8px; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
    display: block; 
    margin: 0 auto; 
    image-rendering: -webkit-optimize-contrast;
    image-rendering: auto;
  }
  .info-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #2196F3; }
  .results-section { background: #e8f5e9; padding: 20px; border-radius: 10px; margin-top: 20px; }
  .image-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin: 15px 0; }
  .image-card h4 { margin: 0 0 10px 0; color: #667eea; }
  #siftResultsSection { margin-top: 30px; }
  #siftResultsSection table { width: 100%; border-collapse: collapse; margin: 15px 0; }
  #siftResultsSection th { background: #667eea; color: white; padding: 10px; text-align: left; border: 1px solid #ddd; }
  #siftResultsSection td { padding: 8px; border: 1px solid #ddd; }
  #siftResultsSection tr:nth-child(even) { background: #f9f9f9; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
  <div style="margin-bottom: 20px;">
    <a href="/modules" class="btn">‚Üê Back to All Modules</a>
  </div>

  <h2>Image Stitching with SIFT Feature Extraction</h2>
  <ol style="line-height: 1.8; margin-bottom: 20px;">
    <li>Upload <strong>at least 4 images</strong> (landscape) or <strong>8 images</strong> (portrait)</li>
    <li>Images should be <strong>consecutive views</strong> with overlapping regions</li>
    <li>Click <strong>Stitch Images</strong> to create panorama and automatically extract SIFT features</li>
    <li><strong>Optional:</strong> Upload a <strong>mobile panorama</strong> to compare with the stitched result</li>
  </ol>

  <div class="info-box">
    <h3 style="margin-top: 0; color: #1976D2;">üì∏ Image Stitching Guidelines</h3>
    <ul style="text-align: left; line-height: 1.8;">
      <li>Capture images with <strong>30-50% overlap</strong> between consecutive images</li>
      <li>Keep camera at <strong>same height</strong> and move horizontally (or vertically for portrait)</li>
      <li>Maintain <strong>similar exposure</strong> and lighting across all images</li>
      <li>Upload images in <strong>order</strong> (left to right or top to bottom)</li>
      <li>Ensure images have <strong>sufficient features</strong> for matching (textures, edges)</li>
      <li>Minimum: <strong>4 images</strong> (landscape) or <strong>8 images</strong> (portrait)</li>
    </ul>
  </div>

  <div class="upload-section">
    <div class="upload-box" onclick="document.getElementById('imageInput').click()">
      <h4>üì§ Add Images</h4>
      <p>Select multiple images</p>
      <input type="file" id="imageInput" accept="image/*" multiple style="display:none" onchange="handleFileUpload(event)">
    </div>
    <div class="upload-box" onclick="document.getElementById('referenceInput').click()">
      <h4>üì± Reference Image (Optional)</h4>
      <p>Upload mobile panorama for comparison</p>
      <input type="file" id="referenceInput" accept="image/*" style="display:none" onchange="handleReferenceUpload(event)">
    </div>
  </div>
  
  <div id="referencePreview" style="display:none; margin: 20px 0; text-align: center;">
    <h4>Reference Image</h4>
    <img id="referencePreviewImg" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 2px solid #667eea;">
    <button class="btn btn-secondary" onclick="removeReference()" style="margin-top: 10px;">Remove Reference</button>
  </div>

  <div id="previewSection" style="display:none;">
    <h3>Uploaded Images (<span id="imageCount">0</span>)</h3>
    <div class="image-preview-grid" id="previewGrid"></div>
    <p style="color: #666; margin-top: 10px;">
      <strong>Note:</strong> Upload at least 4 images (landscape) or 8 images (portrait) for best results.
    </p>
  </div>

  <div style="text-align:center; margin: 20px 0;">
    <button id="stitchBtn" class="btn btn-success" onclick="stitchImages()" disabled>Stitch Images</button>
    <button class="btn btn-secondary" onclick="resetAll()">Reset All</button>
  </div>

  <div id="resultsSection" style="display:none;">
    <h3>Stitching & SIFT Results</h3>
    <div class="results-section">
      <div><strong>Images Stitched:</strong> <span id="numImages">0</span></div>
      <div><strong>Status:</strong> <span id="opencvStatus">-</span></div>
      <div style="margin-top: 10px;"><strong>Note:</strong> <span id="comparisonNote">-</span></div>
    </div>
    
    <div class="image-card" id="stitchedCard" style="display:none;">
      <h4>Stitched Panorama</h4>
      <img id="stitchedImg" alt="Stitched Panorama">
    </div>
    
    <div class="image-card" id="referenceCard" style="display:none;">
      <h4>Mobile Panorama (for comparison)</h4>
      <img id="referenceImg" alt="Mobile Panorama">
    </div>
    
    <div id="siftResultsSection" style="display:none;">
      <h3>SIFT Feature Extraction Results</h3>
      <div class="results-section">
        <div id="siftStats"></div>
      </div>
      <div id="siftMatchesContainer"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let uploadedImages = [];
let referenceImage = null;

function handleFileUpload(e) {
  const files = Array.from(e.target.files);
  if(files.length === 0) return;
  
  files.forEach(file => {
    const r = new FileReader();
    r.onload = (ev) => {
      uploadedImages.push({
        name: file.name,
        data: ev.target.result
      });
      updatePreview();
    };
    r.readAsDataURL(file);
  });
}

function handleReferenceUpload(e) {
  const file = e.target.files[0];
  if(!file) return;
  
  const r = new FileReader();
  r.onload = (ev) => {
    referenceImage = ev.target.result;
    document.getElementById('referencePreviewImg').src = referenceImage;
    document.getElementById('referencePreview').style.display = 'block';
  };
  r.readAsDataURL(file);
}

function removeReference() {
  referenceImage = null;
  document.getElementById('referenceInput').value = '';
  document.getElementById('referencePreview').style.display = 'none';
}

function updatePreview() {
  const grid = document.getElementById('previewGrid');
  const count = document.getElementById('imageCount');
  
  grid.innerHTML = '';
  count.innerText = uploadedImages.length;
  
  uploadedImages.forEach((img, idx) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${img.data}" alt="${img.name}">
      <button class="remove-btn" onclick="removeImage(${idx})">√ó</button>
    `;
    grid.appendChild(div);
  });
  
  document.getElementById('previewSection').style.display = 'block';
  document.getElementById('stitchBtn').disabled = uploadedImages.length < 2;
}

function removeImage(idx) {
  uploadedImages.splice(idx, 1);
  updatePreview();
}

async function stitchImages() {
  if(uploadedImages.length < 2) {
    alert('Please upload at least 2 images');
    return;
  }
  
  if(uploadedImages.length < 4) {
    if(!confirm(`Only ${uploadedImages.length} images uploaded. Recommended: 4+ images (landscape) or 8+ (portrait). Continue anyway?`)) {
      return;
    }
  }
  
  try {
    const imageDataArray = uploadedImages.map(img => img.data);
    const requestData = { images: imageDataArray };
    
    // Add reference image if provided
    if(referenceImage) {
      requestData.reference_image = referenceImage;
    }
    
    document.getElementById('stitchBtn').disabled = true;
    document.getElementById('stitchBtn').innerText = 'Stitching...';
    
    const resp = await fetch('/module4/api/stitch_images', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(requestData)
    });
    
    const res = await resp.json();
    document.getElementById('stitchBtn').disabled = false;
    document.getElementById('stitchBtn').innerText = 'Stitch Images';
    
    if(res.success) {
      document.getElementById('numImages').innerText = res.num_images;
      document.getElementById('opencvStatus').innerText = res.opencv_success ? 'Success' : 'Failed';
      document.getElementById('comparisonNote').innerText = res.comparison_note;
      
      // Show stitched result
      if(res.stitched_opencv) {
        document.getElementById('stitchedImg').src = res.stitched_opencv;
        document.getElementById('stitchedCard').style.display = 'block';
      } else {
        document.getElementById('stitchedCard').style.display = 'none';
      }
      
      // Show mobile panorama separately if provided
      if(res.has_reference && res.reference_image) {
        document.getElementById('referenceImg').src = res.reference_image;
        document.getElementById('referenceCard').style.display = 'block';
      } else {
        document.getElementById('referenceCard').style.display = 'none';
        // Silently skip if no reference was provided or if it failed
        if(referenceImage && !res.has_reference) {
          console.warn('Reference image provided but failed to process: ' + (res.reference_error || 'Unknown error'));
        }
      }
      
      // Display SIFT results
      if(res.sift_results && res.sift_results.length > 0) {
        const statsDiv = document.getElementById('siftStats');
        const matchesContainer = document.getElementById('siftMatchesContainer');
        
        // Build statistics
        let statsHTML = '<h4>SIFT Feature Statistics:</h4><table style="width:100%; border-collapse: collapse; margin: 10px 0;">';
        statsHTML += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd;">Image Pair</th>';
        statsHTML += '<th style="padding: 8px; border: 1px solid #ddd;">Custom Keypoints (A/B)</th>';
        statsHTML += '<th style="padding: 8px; border: 1px solid #ddd;">Custom Matches</th>';
        statsHTML += '<th style="padding: 8px; border: 1px solid #ddd;">Custom Inliers</th>';
        statsHTML += '<th style="padding: 8px; border: 1px solid #ddd;">OpenCV Inliers</th>';
        statsHTML += '<th style="padding: 8px; border: 1px solid #ddd;">Homography</th></tr>';
        
        res.sift_results.forEach((sift, idx) => {
          if(sift.error) {
            statsHTML += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${sift.pair}</td>`;
            statsHTML += `<td colspan="5" style="padding: 8px; border: 1px solid #ddd; color: red;">Error: ${sift.error}</td></tr>`;
          } else {
            statsHTML += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${sift.pair}</td>`;
            statsHTML += `<td style="padding: 8px; border: 1px solid #ddd;">${sift.custom_keypoints_a} / ${sift.custom_keypoints_b}</td>`;
            statsHTML += `<td style="padding: 8px; border: 1px solid #ddd;">${sift.custom_matches}</td>`;
            statsHTML += `<td style="padding: 8px; border: 1px solid #ddd;">${sift.custom_inliers}</td>`;
            statsHTML += `<td style="padding: 8px; border: 1px solid #ddd;">${sift.opencv_inliers}</td>`;
            statsHTML += `<td style="padding: 8px; border: 1px solid #ddd;">${sift.homography_found ? '‚úì' : '‚úó'}</td></tr>`;
          }
        });
        statsHTML += '</table>';
        statsDiv.innerHTML = statsHTML;
        
        // Display match visualizations
        matchesContainer.innerHTML = '';
        res.sift_results.forEach((sift, idx) => {
          if(!sift.error) {
            // Custom SIFT matches
            if(res.sift_matches_images && res.sift_matches_images[idx]) {
              const matchDiv = document.createElement('div');
              matchDiv.className = 'image-card';
              matchDiv.innerHTML = `
                <h4>Custom SIFT Matches: Images ${sift.pair}</h4>
                <img src="${res.sift_matches_images[idx]}" alt="Custom SIFT Matches ${sift.pair}" style="max-width: 100%;">
              `;
              matchesContainer.appendChild(matchDiv);
            }
            
            // OpenCV SIFT matches for comparison
            if(res.sift_opencv_matches_images && res.sift_opencv_matches_images[idx]) {
              const opencvDiv = document.createElement('div');
              opencvDiv.className = 'image-card';
              opencvDiv.innerHTML = `
                <h4>OpenCV SIFT Matches: Images ${sift.pair}</h4>
                <img src="${res.sift_opencv_matches_images[idx]}" alt="OpenCV SIFT Matches ${sift.pair}" style="max-width: 100%;">
              `;
              matchesContainer.appendChild(opencvDiv);
            }
          }
        });
        
        document.getElementById('siftResultsSection').style.display = 'block';
      } else {
        document.getElementById('siftResultsSection').style.display = 'none';
      }
      
      document.getElementById('resultsSection').style.display = 'block';
    } else {
      alert('Error: ' + (res.error || 'Stitching failed'));
    }
  } catch(err) {
    document.getElementById('stitchBtn').disabled = false;
    document.getElementById('stitchBtn').innerText = 'Stitch Images';
    alert('Error: ' + err.message);
  }
}

function resetAll() {
  if(confirm('Reset everything and start over?')) {
    uploadedImages = [];
    referenceImage = null;
    document.getElementById('imageInput').value = '';
    document.getElementById('referenceInput').value = '';
    document.getElementById('previewSection').style.display = 'none';
    document.getElementById('referencePreview').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('stitchBtn').disabled = true;
  }
}
</script>
{% endblock %}

