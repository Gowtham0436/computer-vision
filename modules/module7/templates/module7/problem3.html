{% extends "base.html" %}
{% block title %}Module 7 - Problem 3{% endblock %}
{% block header %}Module 7 - Problem 3{% endblock %}
{% block subheader %}Pose Estimation & Hand Tracking{% endblock %}

{% block styles %}
<style>
  .main-container { max-width: 1400px; margin: 0 auto; }
  .upload-section { text-align: center; margin-bottom: 30px; }
  .upload-box { border: 3px dashed #667eea; border-radius: 10px; padding: 30px; cursor: pointer; transition: background 0.3s; display: inline-block; min-width: 250px; }
  .upload-box:hover { background: #f8f9fa; }
  .image-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 30px 0; }
  .image-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
  .image-card h4 { margin: 0 0 10px 0; color: #667eea; }
  canvas, img { 
    max-width: 100%; 
    max-height: 600px; 
    width: auto; 
    height: auto; 
    border-radius: 8px; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
    display: block; 
    margin: 0 auto; 
    image-rendering: -webkit-optimize-contrast;
    image-rendering: auto;
  }
  .info-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #2196F3; }
  .results-section { background: #e8f5e9; padding: 20px; border-radius: 10px; margin-top: 20px; }
  .csv-section { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107; }
  .method-selector { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; }
  .method-selector label { margin-right: 15px; font-weight: 500; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  table th, table td { padding: 8px; text-align: left; border: 1px solid #ddd; }
  table th { background: #667eea; color: white; }
  table tr:nth-child(even) { background: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
  <div style="margin-bottom: 20px;">
    <a href="/module7" class="btn">‚Üê Back to Module 7</a>
    <a href="/modules" class="btn">All Modules</a>
  </div>

  <h2>Problem 3: Real-time Pose Estimation and Hand Tracking</h2>
  <ol style="line-height: 1.8; margin-bottom: 20px;">
    <li>Upload an image containing a person</li>
    <li>Select tracking method (MediaPipe or OpenPose)</li>
    <li>System detects pose landmarks and hand landmarks</li>
    <li>View visual output and download CSV data</li>
  </ol>

  <div class="info-box">
    <h3 style="margin-top: 0; color: #1976D2;">üìã Pose & Hand Tracking</h3>
    <p style="margin: 0; line-height: 1.8;">
      <strong>Pose Landmarks:</strong> MediaPipe detects 33 pose landmarks including shoulders, elbows, wrists, hips, knees, ankles, and facial keypoints.<br>
      <strong>Hand Landmarks:</strong> Each hand has 21 landmarks (wrist, thumb, index, middle, ring, pinky fingers).<br>
      <strong>CSV Data:</strong> Contains X, Y, Z coordinates, visibility scores, and landmark names for analysis.
    </p>
  </div>

  <div class="method-selector">
    <h4>Tracking Method:</h4>
    <label><input type="radio" name="trackMethod" value="mediapipe" checked> MediaPipe</label>
    <label><input type="radio" name="trackMethod" value="openpose"> OpenPose (requires setup)</label>
  </div>

  <div class="upload-section">
    <div class="upload-box" onclick="document.getElementById('poseInput').click()">
      <h4>üì§ Upload Image</h4>
      <p>Person with visible pose/hands</p>
      <input type="file" id="poseInput" accept="image/*" style="display:none" onchange="handlePoseUpload(event)">
    </div>
    <p id="fileName7_3" style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em; display: none;"></p>
  </div>

  <div style="text-align:center; margin: 20px 0;">
    <button id="trackBtn" class="btn btn-success" onclick="trackPose()" disabled>Track Pose & Hands</button>
    <button class="btn btn-secondary" onclick="resetAll()">Reset</button>
  </div>

  <div id="resultsSection" style="display:none;">
    <h3>Tracking Results</h3>
    <div class="image-grid">
      <div class="image-card">
        <h4>Original Image</h4>
        <img id="originalImg" alt="Original">
      </div>
      <div class="image-card">
        <h4>Pose & Hand Tracking</h4>
        <img id="trackedImg" alt="Tracked">
      </div>
    </div>
    
    <div class="results-section">
      <div><strong>Tracking Method:</strong> <span id="trackMethod">-</span></div>
      <div><strong>Pose Landmarks Detected:</strong> <span id="poseCount">0</span></div>
      <div><strong>Hands Detected:</strong> <span id="handCount">0</span></div>
    </div>

    <div class="csv-section">
      <h3>CSV Data Export</h3>
      <p>CSV file contains all pose and hand landmark data with the following columns:</p>
      <ul style="line-height: 1.8;">
        <li><strong>Type:</strong> POSE or HAND_Left/HAND_Right</li>
        <li><strong>ID:</strong> Landmark index (0-32 for pose, 0-20 for each hand)</li>
        <li><strong>Name:</strong> Landmark name (e.g., LEFT_SHOULDER, WRIST)</li>
        <li><strong>X:</strong> Normalized X coordinate (0-1)</li>
        <li><strong>Y:</strong> Normalized Y coordinate (0-1)</li>
        <li><strong>Z:</strong> Depth coordinate (relative to hip)</li>
        <li><strong>Visibility/Handedness:</strong> Visibility score (0-1) for pose, or Left/Right for hands</li>
      </ul>
      <div style="margin-top: 15px;">
        <button id="downloadBtn" class="btn btn-success" onclick="downloadCSV()" disabled>Download CSV Data</button>
        <span id="csvFilename" style="margin-left: 15px; color: #666;"></span>
      </div>
    </div>

    <div id="landmarksTable" style="display:none;">
      <h3>Landmark Data Preview</h3>
      <div style="max-height: 400px; overflow-y: auto;">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>ID</th>
              <th>Name</th>
              <th>X</th>
              <th>Y</th>
              <th>Z</th>
              <th>Visibility/Handedness</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let poseImage = null;
let csvData = null;
let csvFilename = null;

function handlePoseUpload(e) {
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = (ev) => {
    poseImage = ev.target.result;
    document.getElementById('trackBtn').disabled = false;
    document.getElementById('resultsSection').style.display = 'none';
    // Show filename
    document.getElementById('fileName7_3').textContent = `Uploaded: ${f.name}`;
    document.getElementById('fileName7_3').style.display = 'block';
  };
  r.readAsDataURL(f);
}

async function trackPose() {
  try {
    const method = document.querySelector('input[name="trackMethod"]:checked').value;
    const useMediaPipe = method === 'mediapipe';
    
    document.getElementById('trackBtn').disabled = true;
    document.getElementById('trackBtn').innerText = 'Processing...';
    
    const resp = await fetch('/module7/api/pose_tracking', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        image: poseImage,
        use_mediapipe: useMediaPipe
      })
    });
    
    const res = await resp.json();
    document.getElementById('trackBtn').disabled = false;
    document.getElementById('trackBtn').innerText = 'Track Pose & Hands';
    
    if(res.success) {
      document.getElementById('originalImg').src = res.original_image;
      document.getElementById('trackedImg').src = res.annotated_image;
      document.getElementById('trackMethod').innerText = res.method;
      document.getElementById('poseCount').innerText = res.num_pose_landmarks;
      document.getElementById('handCount').innerText = res.num_hands;
      
      // Store CSV data
      csvData = res.csv_data;
      if(res.csv_filename) {
        csvFilename = res.csv_filename.split('/').pop();
        document.getElementById('csvFilename').innerText = `Saved: ${csvFilename}`;
        document.getElementById('downloadBtn').disabled = false;
      }
      
      // Populate table
      populateTable(res.pose_landmarks, res.hand_landmarks);
      
      document.getElementById('resultsSection').style.display = 'block';
    } else {
      alert('Error: ' + (res.error || 'Pose tracking failed'));
    }
  } catch(err) {
    document.getElementById('trackBtn').disabled = false;
    document.getElementById('trackBtn').innerText = 'Track Pose & Hands';
    alert('Error: ' + err.message);
  }
}

function populateTable(poseLandmarks, handLandmarks) {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  
  // Add pose landmarks
  if(poseLandmarks) {
    poseLandmarks.forEach(landmark => {
      const row = tbody.insertRow();
      row.insertCell(0).innerText = 'POSE';
      row.insertCell(1).innerText = landmark.id;
      row.insertCell(2).innerText = landmark.name;
      row.insertCell(3).innerText = landmark.x.toFixed(4);
      row.insertCell(4).innerText = landmark.y.toFixed(4);
      row.insertCell(5).innerText = landmark.z.toFixed(4);
      row.insertCell(6).innerText = landmark.visibility.toFixed(4);
    });
  }
  
  // Add hand landmarks
  if(handLandmarks) {
    handLandmarks.forEach(hand => {
      hand.landmarks.forEach(landmark => {
        const row = tbody.insertRow();
        row.insertCell(0).innerText = `HAND_${hand.handedness}`;
        row.insertCell(1).innerText = landmark.id;
        row.insertCell(2).innerText = `Hand_${landmark.id}`;
        row.insertCell(3).innerText = landmark.x.toFixed(4);
        row.insertCell(4).innerText = landmark.y.toFixed(4);
        row.insertCell(5).innerText = landmark.z.toFixed(4);
        row.insertCell(6).innerText = hand.handedness;
      });
    });
  }
  
  document.getElementById('landmarksTable').style.display = 'block';
}

function downloadCSV() {
  if(!csvData || !csvFilename) {
    alert('No CSV data available');
    return;
  }
  
  // Create blob and download
  const blob = new Blob([csvData], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = csvFilename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
}

function resetAll() {
  if(confirm('Reset everything?')) {
    poseImage = null;
    csvData = null;
    csvFilename = null;
    document.getElementById('poseInput').value = '';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('trackBtn').disabled = true;
    document.getElementById('fileName7_3').style.display = 'none';
  }
}
</script>
{% endblock %}

